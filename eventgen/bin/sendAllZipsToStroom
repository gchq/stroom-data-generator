#!/bin/bash

if [ "$(pidof -x $(basename $0))" != $$ ]
then
  echo "Another instance of this script is already running"
  exit
fi

if (( $# < 1 ))
then
  echo "Usage $0 <output directory root> [FEED]"
  exit 1
fi

FEED=$2
SUFFIX='.zip'
FILES=$(find $1 -name \*$SUFFIX)

for FILE in $FILES
do
  if (( $# == 1 ))
  then
    FEED=$(basename $FILE | cut -d . -f 1)
  fi
  
  RESPONSE=$(curl -s -w '%{http_code}' -k --data-binary @${FILE} "http://localhost:8080/stroom/noauth/datafeed" -H "Feed:$FEED" -H"Compression:zip" -H"Content-Type:application/audit")
  if (( $RESPONSE == 200 ))
  then
#    mv $FILE $FILE.sent
    rm $FILE
  fi

done


