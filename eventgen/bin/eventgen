#!/bin/bash

#Incrementally generates both older and current data, one hour at a time
#
#This script must be run from a directory containing eventgen.jar (can be symlink)
#

PROCNAME=$(basename $0)
#if [ "$(pidof -x $PROCNAME)" != $$ ]
#then
#  echo "Another instance of this script is already running"
#  exit
#fi

if (( $# < 3 ))
then
  echo "usage: $0 <config yaml> <working directory> <earliest date to generate>"
  echo "example: $0 config/all.yml . 2020-12-31 -s 500"
  exit 1
fi


function init () {
  STATEFILE=$1
  INITIAL_DATE=$2

  if [ ! -f $STATEFILE ]
  then
    #New statefile
    echo $INITIAL_DATE > $STATEFILE
  fi
}

function process () {
  STATEFILE=$1
  NEXT_PERIOD_DELTA=$2
  EARLIEST_EPOCH=$3
  LATEST_EPOCH=$4
  JAR=$5
  CONFIG=$6
  
  RUN_PERIOD=$(< $STATEFILE)
  PERIOD_EPOCH=$(date -u -d "$RUN_PERIOD" +%s)

  read RUN_PERIOD_TIME RUN_PERIOD_DATE <<< $RUN_PERIOD

  if (( $PERIOD_EPOCH >= $EARLIEST_EPOCH && $PERIOD_EPOCH <= $LATEST_EPOCH ))
  then
    java -jar $JAR $CONFIG -r PT1H -p "${RUN_PERIOD_DATE}T${RUN_PERIOD_TIME}.000Z"

    if (( $? == 0 ))
    then
      date -u -d "$RUN_PERIOD $NEXT_PERIOD_DELTA" +"%H:%M:%S %Y-%m-%d" > $STATEFILE
    fi
  fi
}

#----MAIN-----
CONFIG=$1
JAR="$(pwd)/eventgen.jar"
if [ ! -f $JAR ]
then
  echo "Fatal: eventgen.jar (or symlink) must be located in the directory that this script is run from."
  exit 1
fi

cd $2

STATEFILE_BASE=$(basename $0.state)

STATEFILE_OLD=$STATEFILE_BASE".historic"
STATEFILE_NEW=$STATEFILE_BASE".current"

INITIAL_RUN_DATE='00:00:00 '$(date -u +"%Y-%m-%d")
INITIAL_RUN_DATE_OLD=$(date -u -d "$INITIAL_RUN_DATE - 1 hour" +"%H:%M:%S %Y-%m-%d")
init ${STATEFILE_OLD} "${INITIAL_RUN_DATE_OLD}"
init ${STATEFILE_NEW} "${INITIAL_RUN_DATE}"

EARLIEST_EPOCH=$(date -u +%s -d "$3")
HOUR_TRUNC_FORMAT='%Y-%m-%d %H':00:00
LAST_HOUR_START=$(date -d "- 1 hour" -u +"$HOUR_TRUNC_FORMAT")
LATEST_EPOCH=$(date +%s -d "$LAST_HOUR_START")

process ${STATEFILE_OLD} "- 1 hour" "$EARLIEST_EPOCH" "$LATEST_EPOCH" "$JAR" "$CONFIG"
process ${STATEFILE_NEW} "+ 1 hour" "$EARLIEST_EPOCH" "$LATEST_EPOCH" "$JAR" "$CONFIG"




